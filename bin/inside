#!/bin/bash

CONTAINER_HOSTNAME="$(hostname)"
CONTAINER_IMAGE=""
CONTAINER_IMAGE_CODE="ubuntu"
CONTAINER_NAME=""
PULL_BEFORE_RUN=0
COPY_SSHKEYS=0
ENABLE_D_IN_D=0
PERSISTENT=0
WORKDIR=""


usage() {
cat <<EOF
usage: inside [-w dotfiles|ubuntu] [-H hostname] [path]
 -w, --with {dotfiles, *ubuntu}  specify container image
 -p, --persist                   keep container persistent
 -s, --copy-ssh                  copy SSH keys
 -d, --d-in-d                    enable D-in-D mode
 -H, --hostname [hostname]       specify container hostname
 -n, --name [name]               specify container name
     --update                    pull the latest image before use
 -h, --help                      this help text
EOF
}


argparse() {
  while (( "$#" )); do
    case $1 in
      --with|-w)
        echo --with $2
        CONTAINER_IMAGE_CODE="$2"
        shift 2 ;;
      --update)
        PULL_BEFORE_RUN=1
        shift ;;
      --copy-ssh|-s)
        COPY_SSHKEYS=1
        shift ;;
      --d-in-d|-d)
        ENABLE_D_IN_D=1
        shift ;;
      --persist|-p)
        PERSISTENT=1
        shift ;;
      --hostname|-H)
        echo --hostname $2
        CONTAINER_HOSTNAME="$2"
        shift 2 ;;
      --name|-n)
        CONTAINER_NAME="$2"
        echo --name $2
        shift 2 ;;
      --help|-h)
        usage
        exit 0 ;;
      --*|-*)
        echo $opt
        usage
        exit 1 ;;
      *)
        WORKDIR="$1"
        shift ;;
    esac
  done
}


main() {
  local args="$@"

  if (( $# == 0 )); then
    usage
    exit 0
  fi

  argparse $args

  case "$CONTAINER_IMAGE_CODE" in
    "ubuntu")
      CONTAINER_IMAGE="ghcr.io/mi2428/ubuntu:latest" ;;
    "dotfiles")
      CONTAINER_IMAGE="ghcr.io/mi2428/dotfiles:latest" ;;
    *)
      usage
      exit 127 ;;
  esac

  if [[ -z "$CONTAINER_NAME" ]]; then
    CONTAINER_NAME="${CONTAINER_IMAGE_CODE}_$(date "+%Y-%m-%d-%H-%M-%S")"
  fi


  if (( $PULL_BEFORE_RUN == 1 )); then
    docker pull $CONTAINER_IMAGE
  fi

  ARGS=""
  (( $PERSISTENT == 0 ))    && ARGS="${ARGS} --rm"
  (( $COPY_SSHKEYS == 1 ))  && ARGS="${ARGS} -v $HOME/.ssh:/etc/skel/.ssh:ro"
  (( $ENABLE_D_IN_D == 1 )) && ARGS="${ARGS} --privileged --pid=host"

  docker run -it \
    ${ARGS} \
    -w /work \
    -v $(cd $WORKDIR; pwd):/work \
    -e HOST_UID=$(id -u $USER) \
    -e HOST_GID=$(id -g $USER) \
    --dns 9.9.9.9 \
    --name $CONTAINER_NAME \
    --hostname $CONTAINER_HOSTNAME \
    --network host \
    $CONTAINER_IMAGE
}


main $@
