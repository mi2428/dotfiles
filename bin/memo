#!/bin/bash

set -e

declare -r SCRIPT_NAME=$(basename $0)

declare -r BASE_DIR="/home/taichi/dev/memo-mi2428-net"
cd $BASE_DIR

declare -r SERVER_BASE_DIR="/var/local/docker/20-running.d/memo-mi2428-net/www/"
declare -r IMG_BASE_DIR="/var/local/docker/20-running.d/img-mi2428-net/www/blog/"

usage() {
cat <<-EOT
% memo -t ラベル -l [primary,info,success,warning,danger] -c カテゴリ1 -c カテゴリ2 記事タイトル sample.md
EOT
exit 1
}

declare -a CATEGORIES=()
while getopts :t:l:c: OPT; do
    case $OPT in
        t)
            TAG="$OPTARG";;
        l)
            LABEL="$OPTARG";;
        c)
            CATEGORIES=(${CATEGORIES[@]} "$OPTARG");;
        \?)
            usage ;;
    esac
done

str="categories = ["
for category in ${CATEGORIES[@]}; do
    str="$str\"$category\","
done
str="$(echo $str | sed -e "s/,$//")]"
declare -r CATEGORY_STR=$str

shift $(($OPTIND - 1))
declare -r TITLE=$1
declare -r FILE_NAME=$2

hugo new post/${FILE_NAME}
declare -r FILE="$BASE_DIR/content/post/$FILE_NAME"
sed -i -e "s/^categories.*$/$CATEGORY_STR/" $FILE
sed -i -e "s/^label.*$/label = \"$LABEL\"/" $FILE
sed -i -e "s/^tags.*$/tags = [\"$TAG\"]/" $FILE
sed -i -e "s/^title.*$/title = \"$TITLE\"/" $FILE

hugo server --port 61314 --watch 1>/dev/null 2>/dev/null &
google-chrome-stable http://localhost:61314/ 1>/dev/null 2>/dev/null &
$EDITOR $FILE && \
killall hugo
